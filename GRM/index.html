<!DOCTYPE html>
<html>
    <head>
        <title>Diapa</title>
        <meta charset="utf-8" />
        <meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'">
        
        <link href="styles/main.css" rel="stylesheet" />
        <link href="kendo/styles/kendo.mobile.all.min.css" rel="stylesheet" />

        <script src="kendo/js/CriptoJS/aes.js"></script>
        <script src="cordova.js"></script>

        <script src="kendo/js/jquery.min.js"></script>
        <script src="kendo/js/kendo.mobile.min.js"></script>
    </head>

    <style type="text/css"> 
        body
        {
            pointer-events: all !important;
        }
    </style>

    <body>

        <!--Login-->
        <div id="view-login" 
             data-title="Login" 
             data-role="view"
             data-show="loginShow"
             >
            <div id="main_panel">
                <img src="./styles/images/diapa.png" style="height:80px; width:120px;">
                <br/>
                <input value="" id="username"  type="text" name="username" placeholder="Nombre de usuario" />
                <br/>
                <input value="" id="password"  type="password" name="password" placeholder="Contraseña"/>
                <br/>
                <div id="contenedor_boton">
                    <a data-role="button" onclick="login()" style="background-color: black; color: white; font-size: .9em">Ingresar</a>
                </div>
            </div>
        </div>
        <script>
            app = new kendo.mobile.Application($(document.body));
            
            function NavigateBackToHome() 
            {   
                app.navigate("#:back");
            }
            
            //var username;
            //var password;
            //var codigo;
            //var tipo;
            //var id;
            var app;
            var param_index = 0;
            var param_col = 0;
            var varType;
            var varUrl;
            var varData;
            var varContentType;
            var varDataType;
            var varProcessData;
            
            var codigoTempG = 0;
            var codigoTempS = 0;
            var codigoTempV = 0;
            var tipoTemp = 0;
            
            var cartillaTipo1 = 0;
            var cartillaTipo2 = 0;
            var cartillaNombre = "";
            
            var glatitud = 0.00;
            var glongitud = 0.00;
            var gfecha = "";
            var ghora = "";
            var filtrarLibro = false;
            var map = null;
            var marker = null;
            var next = "";
            var codigoCliente = "";
            var codigoRegistro = "";
            var options = { enableHighAccuracy: true, maximumAge:500 };
            var fechaMapa = "";
            var vendedorMapa = "";
            
            $(document).ready(function() 
            {
                try 
                {
                    
                    navigator.geolocation.getCurrentPosition(encontrado, noencontrado, options);
            
                    if (localStorage.getItem("username") != undefined) 
                    {
                        document.getElementById("username").value = localStorage.getItem("username");
                    } 
                    else 
                    {
                        document.getElementById("username").value = "";
                    }
            
                    if (localStorage.getItem("password") != undefined) 
                    {
                        document.getElementById("password").value = localStorage.getItem("password");
                    } 
                    else 
                    {
                        document.getElementById("password").value = "";
                    }
                } 
                catch (ex) 
                {
                    alert("Error al cargar datos de memoria. " + ex.message);
                }
            });
            
            function login() 
            {
                try 
                {
                    $.ajax({
            			url: "http://www.google.com",
            			context: document.body,
            			error: function(jqXHR, exception) 
            			{
            			    alert("No hay internet");	
            			},
            			success: function() 
            			{
                            alert("Hay internet");
            			}
            		})
                    
                    var username = element = document.getElementById("username").value;
                    var password = element = document.getElementById("password").value;
            
                    localStorage.setItem("username", username);
                    localStorage.setItem("password", password);
            
                    if (username == null || username == "") 
                    {
                        alert("Complete el nombre de usuario."); 
                        return;  
                    }
            
                    if (password == null || password == "") 
                    {
                        alert("Complete la contraseña."); 
                        return;
                    }
            
                    var latitude = "NONE";
                    var longitude = "NONE";
                    
                    
                    if (localStorage.getItem("latitude") != undefined) 
                    {
                        latitude = localStorage.getItem("latitude");
                    }
            
                    if (localStorage.getItem("longitude") != undefined) 
                    {
                        longitude = localStorage.getItem("longitude");
                    }
                    
                    
                    var text = password;   
                    var Key = CryptoJS.enc.Utf8.parse("AAECAwQFBgcICQoLDA0ODw==");
                    var IV = CryptoJS.enc.Utf8.parse("YWlFLVEZZUFNaWl=");
                    var encryptedText = CryptoJS.AES.encrypt(text, Key, {iv:IV, mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7});
            
                    var vaType = "GET";
                    var vaUrl = "http://portal.diapa.net:120/home/Autentificar";
                    //vaUrl = "http://localhost:1564/home/Autentificar";
                    var vaData = 'Email=' + String(username) + 
                              '&Password=' + encryptedText +
                              '&Latitud=' + 'NONE' +
                              '&Longitud=' + 'NONE' ;
                              //'&Latitud=' + String(latitude) +
                              //'&Longitud=' + String(longitude) ; 
                    
                    alert(vaUrl);
                    alert(vaData);
                    
                    var vaContentType = "application/json; charset=utf-8";
                    var vaDataType = "json";
                    var vaProcessData = true; 
            
                    $.ajax({
                               type          : vaType,
                               url           : vaUrl,      
                               data          : vaData, 
                               contentType   : vaContentType, 
                               dataType      : vaDataType, 
                               processdata   : vaProcessData, 
                               success       : function(msg){ ServiceSucceeded(msg) },
                               error         : function(xhr, ajaxOptions, thrownError){ ServiceFailed(xhr, ajaxOptions, thrownError) }
                           });
                } 
                catch (err) 
                {
                    alert(err.toString());
                }
            }
            
            function ServiceSucceeded(result) 
            {
                try 
                {
                    if (result.Codigo_Venta == null) 
                    {
                        localStorage.removeItem("codigo");
                        localStorage.removeItem("tipo");
                        localStorage.removeItem("id");
                        alert("Sus credenciales no son validas.");
                    } 
                    else 
                    {
                        localStorage.setItem("codigo", String(result.Codigo_Venta));
                        localStorage.setItem("tipo", String(result.Tipo));
                        localStorage.setItem("id", String(result.id));
            
                        app.navigate("inicio.html", "zoom");
                    }
                } 
                catch (err) 
                {   
                    localStorage.removeItem("codigo");
                    localStorage.removeItem("tipo");
                    localStorage.removeItem("id");
                    alert("Sus credenciales no son validas.");
                }
            }
            
            function ServiceFailed(xhr, ajaxOptions, thrownError) 
            {
                alert( JSON.stringify(xhr) ); 
                alert( JSON.stringify(ajaxOptions) );
                alert( JSON.stringify(thrownError) );
                alert("No se pudo autentificar al usuario.");
            }
            
            function encontrado(position) 
            {
                localStorage.setItem("latitude", String(position.coords.latitude));
                localStorage.setItem("longitude", String(position.coords.longitude));
            }
            
            function noencontrado(error) 
            {
                localStorage.removeItem("latitude");
                localStorage.removeItem("longitude");
                alert("Error, " + error.message);
            }
            
            function loginShow() 
            {
                var codigo = getCodigo();
            
                if (codigo != -1) 
                {
                    app.navigate("inicio.html", "zoom");
                }
            } 
            
            function getCodigo() 
            {
                var codigo = -1;
            
                if (localStorage.getItem("codigo") != undefined) 
                {
                    codigo = parseInt(localStorage.getItem("codigo"));
                }
            
                return codigo;
            }
            
            function getTipo() 
            {
                var tipo = -1;
            
                if (localStorage.getItem("tipo") != undefined) 
                {
                    tipo = parseInt(localStorage.getItem("tipo"));
                }
            
                return tipo;
            }
            
            function getId() 
            {
                var id = -1;
            
                if (localStorage.getItem("id") != undefined) 
                {
                    id = parseInt(localStorage.getItem("id"));
                }
            
                return id;
            }
            
            function getLatitud() 
            {
                var latitud = 0;
            
                if (localStorage.getItem("latitude") != undefined) 
                {
                    latitud = localStorage.getItem("latitude");
                }
            
                return latitud;
            }
            
            function getLongitud() {
                var longitud = 0;
            
                if (localStorage.getItem("longitud") != undefined) {
                    longitud = localStorage.getItem("longitud");
                }
            
                return longitud;
            }
            
            
            
            
            
            function getLatitudX() {
                var latitud = 0;
            
                if (localStorage.getItem("latitudeX") != undefined) {
                    latitud = localStorage.getItem("latitudeX");
                }
            
                return latitud;
            }
            
            function getLongitudX() {
                var longitud = 0;
            
                if (localStorage.getItem("longitudeX") != undefined) {
                    longitud = localStorage.getItem("longitudeX");
                }
            
                return longitud;
            }
            
            function readSettingsWork(resultado) {    
                if (resultado != null) {
                    if (resultado == "SI") {
                        app.navigate(next, "slide:left");    
                    } else {
                        alert(String(resultado));
                    }
                } else {
                    alert("Error, no se pueden leer la configuración de su celular");
                }
            }
            
            function readSettingsNotWork() {
                alert("Error, no se pueden leer la configuración de su celular");
            }
            
            
        </script>
            
    </body>
</html>
    